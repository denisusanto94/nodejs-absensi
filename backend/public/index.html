<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi App | Admin</title>
    <!-- Leaflet Maps CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- QR Scanner Lib -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --bg-color: #f8fafc;
            --sidebar-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --card-radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* --- Login Section --- */
        #login-section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .login-card h2 {
            font-weight: 700;
            color: #1e1b4b;
            margin-bottom: 30px;
        }

        .form-control {
            border-radius: 10px;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .form-control:focus {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        /* --- Main Layout --- */
        #main-section {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Style */
        #sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 30px 24px;
            font-weight: 800;
            font-size: 1.25rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-menu {
            flex: 1;
            padding: 0 16px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 10px;
            color: var(--text-muted);
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-link i {
            font-size: 1.25rem;
        }

        .nav-link:hover {
            background-color: #f1f5f9;
            color: var(--primary-color);
        }

        .nav-link.active {
            background-color: #eef2ff;
            color: var(--primary-color);
        }

        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid #e2e8f0;
        }

        /* Content Area */
        .content-container {
            margin-left: 280px;
            flex: 1;
            padding: 40px;
            max-width: 1200px;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-weight: 700;
            font-size: 1.875rem;
            letter-spacing: -0.025em;
        }

        .card {
            border: none;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            background-color: white;
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 16px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 0.05em;
        }

        .table tbody td {
            padding: 16px;
            vertical-align: middle;
            color: var(--text-main);
            border-bottom: 1px solid #f1f5f9;
        }

        .badge {
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .bg-success-subtle {
            background-color: #dcfce7 !important;
            color: #166534 !important;
        }

        .bg-danger-subtle {
            background-color: #fee2e2 !important;
            color: #991b1b !important;
        }

        .bg-blue-subtle {
            background-color: #dbeafe !important;
            color: #1e40af !important;
        }

        /* Modal Customization */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }

        .modal-header {
            border-bottom: 1px solid #f1f5f9;
            padding: 24px;
        }

        .modal-body {
            padding: 24px;
        }

        #map-container {
            height: 300px;
            width: 100%;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            z-index: 1;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            background: #000;
        }

        .camera-overlay {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
        }

        #face-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px dashed #fff;
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>

    <!-- Login Area -->
    <div id="login-section">
        <div class="login-card">
            <div class="text-center mb-4">
                <div class="display-6 mb-2" style="color: var(--primary-color)"><i class="bi bi-person-lock"></i></div>
                <h2>Absensi App</h2>
                <p class="text-muted">Enter your credentials to continue</p>
            </div>
            <div id="error-msg" class="alert alert-danger hidden"></div>
            <div class="mb-3">
                <label class="form-label font-weight-bold">Username</label>
                <input type="text" id="username" class="form-control" placeholder="admin">
            </div>
            <div class="mb-4">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-control">
            </div>
            <button class="btn btn-primary w-100 mb-2" onclick="login()">Sign In</button>
        </div>
    </div>

    <!-- Layout Container -->
    <div id="main-section" class="hidden">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <i class="bi bi-geo-alt-fill"></i>
                <span id="app-brand-name">Absensi Admin</span>
            </div>
            <div class="sidebar-menu">
                <a href="javascript:void(0)" class="nav-link active" onclick="switchTab('attendance', this)">
                    <i class="bi bi-clock-history"></i>
                    <span id="activity-tab-label">Dashboard</span>
                </a>
                <div id="admin-menus">
                    <a href="javascript:void(0)" class="nav-link" onclick="switchTab('users', this)">
                        <i class="bi bi-people"></i>
                        <span>Users Directory</span>
                    </a>
                    <a href="javascript:void(0)" class="nav-link" onclick="switchTab('office', this)">
                        <i class="bi bi-building-gear"></i>
                        <span>Office Locations</span>
                    </a>
                </div>
                <div id="employee-menus" class="hidden">
                    <a href="javascript:void(0)" class="nav-link" onclick="switchTab('scan', this)">
                        <i class="bi bi-camera"></i>
                        <span>Scan Attendance</span>
                    </a>
                </div>
            </div>

            <div class="mt-auto p-4 border-top">
                <button
                    class="btn btn-light w-100 text-danger border-0 d-flex align-items-center justify-content-center gap-2"
                    onclick="logout()">
                    <i class="bi bi-box-arrow-left"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Dynamic Content Area -->
        <div class="content-container">

            <!-- Attendance Section for Employee -->
            <div id="section-scan" class="hidden">
                <div class="page-header mb-4">
                    <p class="text-muted mb-1">Attendance</p>
                    <h1 class="page-title">Scan Registration</h1>
                </div>

                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card p-4 text-center">
                            <div class="display-6 text-primary mb-3"><i class="bi bi-person-bounding-box"></i></div>
                            <h4 class="mb-3">Face Verification</h4>
                            <div class="camera-overlay mb-4">
                                <video id="face-video" autoplay playsinline></video>
                                <div class="scan-frame"></div>
                            </div>
                            <button class="btn btn-primary btn-lg px-5" onclick="processFaceScan()">
                                <i class="bi bi-camera-fill me-2"></i> Take Photo
                            </button>
                            <div class="mt-3">
                                <label class="text-primary cursor-pointer" style="cursor: pointer">
                                    <i class="bi bi-file-earmark-image"></i> Manual Upload
                                    <input type="file" class="hidden" accept="image/*"
                                        onchange="uploadFaceImage(event)">
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card p-4 text-center">
                            <div class="display-6 text-primary mb-3"><i class="bi bi-qr-code-scan"></i></div>
                            <h4 class="mb-3">QR Code Scan</h4>
                            <div id="reader" class="mb-4"></div>
                            <div class="d-grid gap-2 col-8 mx-auto">
                                <button class="btn btn-outline-primary btn-lg" id="qr-btn" onclick="toggleQRScanner()">
                                    <i class="bi bi-play-fill me-2"></i> Start QR Scanner
                                </button>
                                <label class="btn btn-light text-primary border" style="cursor: pointer">
                                    <i class="bi bi-upload me-2"></i> Upload QR Image
                                    <input type="file" class="hidden" accept="image/*" onchange="uploadQRImage(event)">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard/Attendance Section -->
            <div id="section-attendance">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Overview</p>
                        <h1 class="page-title">Attendance Activity</h1>
                    </div>
                    <button class="btn btn-primary" onclick="exportData()">
                        <i class="bi bi-download me-2"></i> Export Data
                    </button>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table id="attendance-table" class="table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Activity</th>
                                    <th>Date & Time</th>
                                    <th>Status</th>
                                    <th>Geo Location</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Management: Users Section -->
            <div id="section-users" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Management</p>
                        <h1 class="page-title">Users Directory</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="bi bi-plus-lg me-2"></i> Add New User
                    </button>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table id="users-table" class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Full Name</th>
                                    <th>Role</th>
                                    <th>Shift Hours</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Management: Office Section -->
            <div id="section-office" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Presence</p>
                        <h1 class="page-title">Office Locations</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddOfficeModal()">
                        <i class="bi bi-plus-lg me-2"></i> Add Location
                    </button>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table id="office-table" class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Latitude</th>
                                    <th>Longitude</th>
                                    <th>Radius</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Generic Modal for Forms -->
    <div class="modal fade" id="formModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="font-weight: 700">Add Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Dynamic Form Content -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet Maps JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- HTML5-QRCODE for QR Scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        const API_URL = '/api';
        let formModal;
        let cachedUsers = [];
        let cachedOffices = [];
        let qrScanner = null;
        let videoStream = null;

        function checkAuth() {
            try {
                const token = localStorage.getItem('token');
                const role = localStorage.getItem('userRole');
                console.log("Checking auth...", { hasToken: !!token, role });

                if (token && role) {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('main-section').classList.remove('hidden');

                    if (role === 'admin') {
                        document.getElementById('admin-menus').classList.remove('hidden');
                        document.getElementById('employee-menus').classList.add('hidden');
                        document.getElementById('app-brand-name').innerText = 'Absensi Admin';
                        document.getElementById('activity-tab-label').innerText = 'Company Activity';
                        const navLink = document.querySelector('.nav-link[onclick*="attendance"]');
                        switchTab('attendance', navLink);
                    } else {
                        document.getElementById('admin-menus').classList.add('hidden');
                        document.getElementById('employee-menus').classList.remove('hidden');
                        document.getElementById('app-brand-name').innerText = 'Absensi Employee';
                        document.getElementById('activity-tab-label').innerText = 'My Activity';
                        const navLink = document.querySelector('.nav-link[onclick*="scan"]');
                        switchTab('scan', navLink);
                    }

                    loadAttendance();
                }
            } catch (err) {
                console.error("Auth check failed:", err);
            }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('error-msg');

            try {
                console.log("Attempting login for:", username);
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                console.log("Login response:", data);

                if (res.ok && data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('userRole', data.user.role);
                    console.log("Login successful, reloading...");
                    location.reload();
                } else {
                    errorEl.innerText = data.message || 'Unauthorized access';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                console.error("Login request failed:", err);
                alert('Network error. Is the server running?');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            location.reload();
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if (el) el.classList.add('active');

            ['attendance', 'users', 'office', 'scan'].forEach(t => {
                const sec = document.getElementById(`section-${t}`);
                if (sec) sec.classList.add('hidden');
            });
            const targetSec = document.getElementById(`section-${tab}`);
            if (targetSec) targetSec.classList.remove('hidden');

            if (tab === 'attendance') loadAttendance();
            if (tab === 'users') loadUsers();
            if (tab === 'office') loadOffices();

            // Manage Camera Streams
            if (tab === 'scan') {
                initFaceCamera();
            } else {
                stopFaceCamera();
                stopQRScanner();
            }
        }

        async function fetchAPI(endpoint) {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}${endpoint}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.status === 403) logout();
            return res.json();
        }

        async function loadAttendance() {
            const data = await fetchAPI('/attendance/all');
            const tbody = document.querySelector('#attendance-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center gap-3">
                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px">
                                <i class="bi bi-person text-primary"></i>
                            </div>
                            <div>
                                <div class="fw-semibold">${row.name}</div>
                                <div class="text-muted small">${row.device_info}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${row.type.startsWith('check_in') ? 'bg-blue-subtle' : 'bg-warning-subtle text-warning'}">
                            ${row.type.replace('_', ' ').toUpperCase()}
                        </span>
                    </td>
                    <td>${new Date(row.timestamp).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' })}</td>
                    <td>
                        <span class="badge ${row.status === 'valid' ? 'bg-success-subtle' : 'bg-danger-subtle'}">
                            ${row.status.toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <a href="https://www.google.com/maps?q=${row.latitude},${row.longitude}" target="_blank" class="btn btn-sm btn-light">
                            <i class="bi bi-geo-alt"></i> ${parseFloat(row.latitude).toFixed(4)}, ${parseFloat(row.longitude).toFixed(4)}
                        </a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadUsers() {
            const data = await fetchAPI('/users');
            cachedUsers = data;
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td class="fw-medium">${row.username}</td>
                    <td>${row.name}</td>
                    <td><span class="badge bg-light text-dark border">${row.role}</span></td>
                    <td>${row.shift_start} - ${row.shift_end}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="showEditUserModal(${row.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('users', ${row.id}, loadUsers)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadOffices() {
            const data = await fetchAPI('/offices');
            cachedOffices = data;
            const tbody = document.querySelector('#office-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="fw-medium">${row.name}</td>
                    <td>${row.latitude}</td>
                    <td>${row.longitude}</td>
                    <td>${row.radius}m</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="showEditOfficeModal(${row.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('offices', ${row.id}, loadOffices)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteItem(type, id, callback) {
            if (!confirm('Are you sure you want to remove this entry?')) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/${type}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) callback();
        }

        async function handleFormSubmit(event, endpoint, callback, method = 'POST') {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());
            const token = localStorage.getItem('token');

            const res = await fetch(`${API_URL}${endpoint}`, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                formModal.hide();
                callback();
            } else {
                const err = await res.json();
                alert(err.message || 'Operation failed');
            }
        }

        function showAddUserModal() {
            document.querySelector('#formModal .modal-dialog').classList.remove('modal-lg');
            document.querySelector('#formModal .modal-title').innerText = 'Register New User';
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/users', loadUsers)">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Username (NIP/ID)</label>
                        <input type="text" name="username" class="form-control" placeholder="12345" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Access Password</label>
                        <input type="password" name="password" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Employee Name</label>
                        <input type="text" name="name" class="form-control" placeholder="John Doe" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">System Role</label>
                        <select name="role" class="form-select">
                            <option value="employee">Employee</option>
                            <option value="admin">System Admin</option>
                        </select>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col">
                            <label class="form-label small text-muted">Start Shift</label>
                            <input type="time" name="shift_start" class="form-control" value="08:00">
                        </div>
                        <div class="col">
                            <label class="form-label small text-muted">End Shift</label>
                            <input type="time" name="shift_end" class="form-control" value="17:00">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 shadow-sm">Save Employee</button>
                </form>
            `;
            formModal.show();
        }

        function showEditUserModal(userId) {
            document.querySelector('#formModal .modal-dialog').classList.remove('modal-lg');
            const user = cachedUsers.find(u => u.id === userId);
            if (!user) return;

            document.querySelector('#formModal .modal-title').innerText = 'Edit User: ' + user.name;
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/users/${user.id}', loadUsers, 'PUT')">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Username (NIP/ID)</label>
                        <input type="text" name="username" class="form-control" value="${user.username}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">New Password (leave blank to keep current)</label>
                        <input type="password" name="password" class="form-control" placeholder="********">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Employee Name</label>
                        <input type="text" name="name" class="form-control" value="${user.name}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">System Role</label>
                        <select name="role" class="form-select">
                            <option value="employee" ${user.role === 'employee' ? 'selected' : ''}>Employee</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>System Admin</option>
                        </select>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col">
                            <label class="form-label small text-muted">Start Shift</label>
                            <input type="time" name="shift_start" class="form-control" value="${user.shift_start}">
                        </div>
                        <div class="col">
                            <label class="form-label small text-muted">End Shift</label>
                            <input type="time" name="shift_end" class="form-control" value="${user.shift_end}">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 shadow-sm">Update User</button>
                </form>
            `;
            formModal.show();
        }

        function showAddOfficeModal() {
            document.querySelector('#formModal .modal-dialog').classList.add('modal-lg');
            document.querySelector('#formModal .modal-title').innerText = 'Add Office Geofence';
            document.getElementById('modal-body').innerHTML = `
                <div class="search-container">
                    <div class="input-group">
                        <input type="text" id="map-search" class="form-control" placeholder="Search location (e.g. Monas, Jakarta)">
                        <button class="btn btn-secondary" type="button" onclick="searchLocation()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div id="map-container"></div>
                <form onsubmit="handleFormSubmit(event, '/offices', loadOffices)">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Location Name</label>
                        <input type="text" name="name" class="form-control" placeholder="Main Office" required>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col">
                            <label class="form-label small text-muted">Latitude</label>
                            <input type="text" name="latitude" id="office-lat" class="form-control" placeholder="-6.1234" required>
                        </div>
                        <div class="col">
                            <label class="form-label small text-muted">Longitude</label>
                            <input type="text" name="longitude" id="office-lng" class="form-control" placeholder="106.1234" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small text-muted">Accuracy Radius (Meters)</label>
                        <input type="number" name="radius" class="form-control" value="100">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 shadow-sm">Enable Geofence</button>
                </form>
            `;
            formModal.show();

            // Wait for modal to be shown before initializing map
            setTimeout(initMap, 500);
        }

        function showEditOfficeModal(officeId) {
            const office = cachedOffices.find(o => o.id === officeId);
            if (!office) return;

            document.querySelector('#formModal .modal-dialog').classList.add('modal-lg');
            document.querySelector('#formModal .modal-title').innerText = 'Edit Office: ' + office.name;
            document.getElementById('modal-body').innerHTML = `
                <div class="search-container">
                    <div class="input-group">
                        <input type="text" id="map-search" class="form-control" placeholder="Search location...">
                        <button class="btn btn-secondary" type="button" onclick="searchLocation()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div id="map-container"></div>
                <form onsubmit="handleFormSubmit(event, '/offices/' + ${office.id}, loadOffices, 'PUT')">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Location Name</label>
                        <input type="text" name="name" class="form-control" value="${office.name}" required>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col">
                            <label class="form-label small text-muted">Latitude</label>
                            <input type="text" name="latitude" id="office-lat" class="form-control" value="${office.latitude}" required>
                        </div>
                        <div class="col">
                            <label class="form-label small text-muted">Longitude</label>
                            <input type="text" name="longitude" id="office-lng" class="form-control" value="${office.longitude}" required>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small text-muted">Accuracy Radius (Meters)</label>
                        <input type="number" name="radius" class="form-control" value="${office.radius}">
                    </div>
                    <button type="submit" class="btn btn-primary w-100 shadow-sm">Update Location</button>
                </form>
            `;
            formModal.show();
            setTimeout(() => initMap(parseFloat(office.latitude), parseFloat(office.longitude)), 500);
        }

        let map, marker;
        function initMap(lat = -6.175392, lng = 106.827153) {
            const pos = [lat, lng];
            if (map) map.remove();

            map = L.map('map-container').setView(pos, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            marker = L.marker(pos, { draggable: true }).addTo(map);

            const updateFields = (lat, lng) => {
                document.getElementById('office-lat').value = lat.toFixed(8);
                document.getElementById('office-lng').value = lng.toFixed(8);
            };

            marker.on('dragend', () => {
                const pos = marker.getLatLng();
                updateFields(pos.lat, pos.lng);
            });

            map.on('click', (e) => {
                marker.setLatLng(e.latlng);
                updateFields(e.latlng.lat, e.latlng.lng);
            });

            // Trigger window resize to fix leaflet layout bugs in hidden containers
            setTimeout(() => map.invalidateSize(), 100);
        }

        async function searchLocation() {
            const query = document.getElementById('map-search').value;
            if (!query) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data.length > 0) {
                    const pos = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    map.setView(pos, 16);
                    marker.setLatLng(pos);
                    document.getElementById('office-lat').value = pos[0].toFixed(8);
                    document.getElementById('office-lng').value = pos[1].toFixed(8);
                } else {
                    alert('Location not found');
                }
            } catch (err) {
                alert('Search failed');
            }
        }

        async function exportData() {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/attendance/export`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_export_${new Date().getTime()}.xlsx`;
                a.click();
            }
        }

        // Camera Logic

        async function initFaceCamera() {
            try {
                const video = document.getElementById('face-video');
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" }
                });
                video.srcObject = videoStream;
            } catch (err) {
                console.error("Camera error:", err);
                alert("Please allow camera access for face verification");
            }
        }

        function stopFaceCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        function processFaceScan() {
            // Simulation of face analysis
            alert("Face verified! Coordinates captured. Attendance logged.");
            // In real app, here you would capture frame and send to backend
        }

        function toggleQRScanner() {
            const btn = document.getElementById('qr-btn');
            if (qrScanner) {
                stopQRScanner();
            } else {
                startQRScanner();
            }
        }

        function startQRScanner() {
            const btn = document.getElementById('qr-btn');
            qrScanner = new Html5Qrcode("reader");
            qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    alert(`QR Code Scanned: ${decodedText}`);
                    stopQRScanner();
                    // Process attendance based on QR payload
                },
                (errorMessage) => { }
            ).then(() => {
                btn.innerHTML = '<i class="bi bi-stop-fill me-2"></i> Stop Scanner';
                btn.classList.replace('btn-outline-primary', 'btn-danger');
            }).catch(err => {
                alert("Camera error. Please ensure permissions are granted.");
            });
        }

        function stopQRScanner() {
            const btn = document.getElementById('qr-btn');
            if (qrScanner) {
                qrScanner.stop().then(() => {
                    qrScanner = null;
                    btn.innerHTML = '<i class="bi bi-play-fill me-2"></i> Start QR Scanner';
                    btn.classList.replace('btn-danger', 'btn-outline-primary');
                });
            }
        }

        function uploadFaceImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Preview or process
            console.log("Face image uploaded:", file.name);
            alert(`Photo ${file.name} uploaded successfully! Face verified.`);
        }

        function uploadQRImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const html5QrCode = new Html5Qrcode("reader");
            html5QrCode.scanFile(file, true)
                .then(decodedText => {
                    alert(`QR Code Scanned from file: ${decodedText}`);
                    // Process attendance...
                })
                .catch(err => {
                    alert("No QR code found in this image. Please try another one.");
                    console.error("Scan error:", err);
                });
        }

        window.onload = () => {
            formModal = new bootstrap.Modal(document.getElementById('formModal'));
            checkAuth();
        };
    </script>
</body>

</html>