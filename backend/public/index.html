<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi App | Admin</title>
    <!-- Leaflet Maps CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- QR Scanner Lib -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-color: #6366f1;
            --primary-hover: #4f46e5;
            --bg-color: #f8fafc;
            --sidebar-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --card-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --card-radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow-x: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* --- Login Section --- */
        #login-section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .login-card h2 {
            font-weight: 700;
            color: #1e1b4b;
            margin-bottom: 30px;
        }

        .form-control {
            border-radius: 10px;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            transition: all 0.2s;
        }

        .form-control:focus {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        /* --- Main Layout --- */
        #main-section {
            display: flex;
            min-height: 100vh;
        }

        /* ===== Desktop Sidebar ===== */
        #sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 30px 24px;
            font-weight: 800;
            font-size: 1.25rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-menu {
            flex: 1;
            padding: 0 16px;
            overflow-y: auto;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 4px;
            border-radius: 10px;
            color: var(--text-muted);
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
        }

        .nav-link i {
            font-size: 1.25rem;
        }

        .nav-link:hover {
            background-color: #f1f5f9;
            color: var(--primary-color);
        }

        .nav-link.active {
            background-color: #eef2ff;
            color: var(--primary-color);
        }

        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid #e2e8f0;
        }

        /* ===== Mobile Top Header ===== */
        #mobile-header {
            display: none;
            background: white;
            padding: 0 20px;
            height: 60px;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 1100;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.06);
        }

        #mobile-header .mobile-brand {
            font-weight: 800;
            font-size: 1.1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #mobile-header .mobile-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-mobile-logout {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #fee2e2;
            background: #fff;
            color: #dc2626;
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-mobile-logout:hover {
            background: #fef2f2;
        }

        .navbar-toggle {
            display: flex;
            align-items: center;
            background: none;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            color: var(--text-main);
            font-size: 1.3rem;
            transition: all 0.2s;
        }

        .navbar-toggle:hover {
            background: #f1f5f9;
        }

        /* Mobile dropdown menu */
        .navbar-mobile-menu {
            display: none;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            padding: 8px 16px 16px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.08);
        }

        .navbar-mobile-menu.open {
            display: block;
        }

        .navbar-mobile-menu .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 10px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.15s;
            text-decoration: none;
        }

        .navbar-mobile-menu .nav-link:hover {
            background-color: #f1f5f9;
            color: var(--primary-color);
        }

        .navbar-mobile-menu .nav-link.active {
            background-color: #eef2ff;
            color: var(--primary-color);
        }

        .navbar-mobile-menu .nav-link i {
            font-size: 1.15rem;
            width: 22px;
            text-align: center;
        }

        .navbar-mobile-menu .mobile-section-label {
            padding: 10px 16px 4px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.05em;
        }

        .navbar-mobile-menu .mobile-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 8px 0;
        }

        /* Content Area */
        .content-container {
            margin-left: 280px;
            flex: 1;
            padding: 40px;
            width: calc(100% - 280px);
            min-height: 100vh;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-weight: 700;
            font-size: 1.875rem;
            letter-spacing: -0.025em;
        }

        .card {
            border: none;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            background-color: white;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background-color: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 16px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 0.05em;
        }

        .table tbody td {
            padding: 16px;
            vertical-align: middle;
            color: var(--text-main);
            border-bottom: 1px solid #f1f5f9;
        }

        .badge {
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .bg-success-subtle {
            background-color: #dcfce7 !important;
            color: #166534 !important;
        }

        .bg-danger-subtle {
            background-color: #fee2e2 !important;
            color: #991b1b !important;
        }

        .bg-blue-subtle {
            background-color: #dbeafe !important;
            color: #1e40af !important;
        }

        /* Modal Customization */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
        }

        .modal-header {
            border-bottom: 1px solid #f1f5f9;
            padding: 24px;
        }

        .modal-body {
            padding: 24px;
        }

        #map-container {
            height: 300px;
            width: 100%;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            z-index: 1;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            background: #000;
        }

        .camera-overlay {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
        }

        #face-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px dashed #fff;
            border-radius: 20px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        /* --- Responsive: Mobile/Tablet --- */
        @media (max-width: 1024px) {
            #main-section {
                flex-direction: column;
            }

            #sidebar {
                display: none !important;
            }

            #mobile-header {
                display: flex;
                width: 100%;
            }

            .navbar-mobile-menu {
                width: 100%;
            }

            .content-container {
                margin-left: 0;
                padding: 20px;
                width: 100%;
                max-width: 100%;
                min-height: auto;
            }

            .page-title {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 15px;
            }

            .btn-primary {
                width: 100%;
            }

            .login-card {
                padding: 25px;
                margin: 20px;
            }

            .content-container {
                padding: 16px;
            }
        }

        /* Smooth Scrolling */
        html {
            scroll-behavior: smooth;
        }

        #main-section {
            overflow-y: auto;
        }

        /* --- Attendance Photo Thumbnails --- */
        .foto-thumbnail {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .foto-thumbnail:hover {
            border-color: var(--primary-color);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .foto-placeholder {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #cbd5e1;
            font-size: 1.2rem;
        }

        /* --- Photo Lightbox --- */
        .foto-lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }

        .foto-lightbox.active {
            display: flex;
        }

        .foto-lightbox img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: lightboxZoomIn 0.25s ease;
        }

        .foto-lightbox .lightbox-close {
            position: absolute;
            top: 20px;
            right: 24px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            background: rgba(255,255,255,0.15);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .foto-lightbox .lightbox-close:hover {
            background: rgba(255,255,255,0.3);
        }

        @keyframes lightboxZoomIn {
            from { transform: scale(0.85); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>

<body>

    <!-- Login Area -->
    <div id="login-section">
        <div class="login-card">
            <div class="text-center mb-4">
                <div class="display-6 mb-2" style="color: var(--primary-color)"><i class="bi bi-person-lock"></i></div>
                <h2>Absensi App</h2>
                <p class="text-muted">Enter your credentials to continue</p>
            </div>
            <div id="error-msg" class="alert alert-danger hidden"></div>
            <div class="mb-3">
                <label class="form-label font-weight-bold">Email Address</label>
                <input type="email" id="email" class="form-control" placeholder="admin@company.com">
            </div>
            <div class="mb-4">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-control">
            </div>
            <button class="btn btn-primary w-100 mb-2" onclick="login()">Sign In</button>
        </div>
    </div>

    <!-- Layout Container -->
    <div id="main-section" class="hidden">

        <!-- ===== Mobile Header (shown ≤1024px) ===== -->
        <div id="mobile-header">
            <div class="mobile-brand">
                <i class="bi bi-geo-alt-fill"></i>
                <span>Absensi Admin</span>
            </div>
            <div class="mobile-actions">
                <button class="btn-mobile-logout" onclick="logout()">
                    <i class="bi bi-box-arrow-left"></i> Logout
                </button>
                <button class="navbar-toggle" onclick="toggleMobileMenu()">
                    <i class="bi bi-list" id="hamburgerIcon"></i>
                </button>
            </div>
        </div>

        <!-- Mobile dropdown menu (shown ≤1024px when toggled) -->
        <div class="navbar-mobile-menu" id="mobileMenu">
            <a href="javascript:void(0)" class="nav-link active" onclick="switchTab('attendance', this)">
                <i class="bi bi-clock-history"></i>
                <span>Attendance</span>
            </a>
            <a href="javascript:void(0)" class="nav-link" onclick="switchTab('leaves', this)"
                data-perm="manage_leaves_permits">
                <i class="bi bi-file-earmark-text"></i>
                <span>Leaves / Permits</span>
            </a>
            <a href="javascript:void(0)" class="nav-link" onclick="switchTab('attendance_transum', this)"
                data-perm="manage_attendance_transum">
                <i class="bi bi-train-front"></i>
                <span>Absensi Rabu</span>
            </a>

            <div class="mobile-divider admin-only"></div>
            <div class="mobile-section-label admin-only">Management</div>

            <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('users', this)">
                <i class="bi bi-people"></i>
                <span>Users</span>
            </a>
            <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('divisions', this)">
                <i class="bi bi-diagram-3"></i>
                <span>Divisions</span>
            </a>
            <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('roles', this)">
                <i class="bi bi-shield-lock"></i>
                <span>Roles</span>
            </a>
            <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('permissions', this)">
                <i class="bi bi-key"></i>
                <span>Permissions</span>
            </a>

            <div class="mobile-divider admin-only"></div>
            <div class="mobile-section-label admin-only">System Master</div>

            <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('office', this)">
                <i class="bi bi-building"></i>
                <span>Offices</span>
            </a>
            <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('shifts', this)">
                <i class="bi bi-stopwatch"></i>
                <span>Shifts</span>
            </a>
            <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('holidays', this)">
                <i class="bi bi-calendar-event"></i>
                <span>Holidays</span>
            </a>
        </div>

        <!-- ===== Desktop Sidebar (shown >1024px) ===== -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <i class="bi bi-geo-alt-fill"></i>
                <span id="app-brand-name">Absensi Admin</span>
            </div>
            <div class="sidebar-menu">
                <a href="javascript:void(0)" class="nav-link active" onclick="switchTab('attendance', this)"
                    data-perm="manage_attendance">
                    <i class="bi bi-clock-history"></i>
                    <span>Attendance</span>
                </a>
                <a href="javascript:void(0)" class="nav-link" onclick="switchTab('leaves', this)"
                    data-perm="manage_leaves_permits">
                    <i class="bi bi-file-earmark-text"></i>
                    <span>Leaves / Permits</span>
                </a>
                <a href="javascript:void(0)" class="nav-link" onclick="switchTab('attendance_transum', this)"
                    data-perm="manage_attendance_transum">
                    <i class="bi bi-train-front"></i>
                    <span>Absensi Rabu</span>
                </a>

                <div class="mt-4 mb-2 px-3 small text-muted text-uppercase fw-bold admin-only"
                    style="font-size: 0.65rem; letter-spacing: 0.05em;">Management</div>
                <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('users', this)">
                    <i class="bi bi-people"></i>
                    <span>Users</span>
                </a>
                <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('divisions', this)">
                    <i class="bi bi-diagram-3"></i>
                    <span>Divisions</span>
                </a>
                <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('roles', this)">
                    <i class="bi bi-shield-lock"></i>
                    <span>Roles</span>
                </a>
                <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('permissions', this)">
                    <i class="bi bi-key"></i>
                    <span>Permissions</span>
                </a>

                <div class="mt-4 mb-2 px-3 small text-muted text-uppercase fw-bold admin-only"
                    style="font-size: 0.65rem; letter-spacing: 0.05em;">System Master</div>
                <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('office', this)">
                    <i class="bi bi-building"></i>
                    <span>Offices</span>
                </a>
                <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('shifts', this)">
                    <i class="bi bi-stopwatch"></i>
                    <span>Shifts</span>
                </a>
                <a href="javascript:void(0)" class="nav-link admin-only" onclick="switchTab('holidays', this)">
                    <i class="bi bi-calendar-event"></i>
                    <span>Holidays</span>
                </a>
            </div>

            <div class="mt-auto p-4 border-top">
                <button
                    class="btn btn-light w-100 text-danger border-0 d-flex align-items-center justify-content-center gap-2"
                    onclick="logout()">
                    <i class="bi bi-box-arrow-left"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Dynamic Content Area -->
        <div class="content-container">

            <!-- Attendance Section -->
            <div id="section-attendance">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Activity</p>
                        <h1 class="page-title">Attendance Log</h1>
                    </div>
                    <button class="btn btn-primary" onclick="exportData()">
                        <i class="bi bi-download me-2"></i> Export Excel
                    </button>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table id="attendance-table" class="table">
                            <thead>
                                <tr>
                                    <th>User / Office</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th>Status</th>
                                    <th>Foto Check In</th>
                                    <th>Foto Check Out</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Absensi Rabu / Attendance Transum Section -->
            <div id="section-attendance_transum" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Activity</p>
                        <h1 class="page-title">Absensi Rabu</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddTransumModal()">
                        <i class="bi bi-plus-lg me-2"></i> Add Record
                    </button>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table id="transum-table" class="table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>City</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Leaves Section -->
            <div id="section-leaves" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Activity</p>
                        <h1 class="page-title">Leaves & Permits</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddLeaveModal()">
                        <i class="bi bi-plus-lg me-2"></i> Request Leave
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="leaves-table" class="table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Type</th>
                                    <th>Period</th>
                                    <th>Reason</th>
                                    <th>Status</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="section-users" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Management</p>
                        <h1 class="page-title">Users</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <i class="bi bi-person-plus me-2"></i> Add User
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="users-table" class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Name</th>
                                    <th>Division</th>
                                    <th>Office</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Divisions Section -->
            <div id="section-divisions" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Management</p>
                        <h1 class="page-title">Divisions</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddDivisionModal()">
                        <i class="bi bi-plus-lg me-2"></i> Add Division
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="divisions-table" class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Division Name</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Roles Section -->
            <div id="section-roles" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Management</p>
                        <h1 class="page-title">Roles</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddRoleModal()">
                        <i class="bi bi-shield-lock me-2"></i> Add Role
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="roles-table" class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Role Name</th>
                                    <th>Permissions</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Permissions Section -->
            <div id="section-permissions" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">Management</p>
                        <h1 class="page-title">Permissions</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddPermissionModal()">
                        <i class="bi bi-key me-2"></i> Add Permission
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="permissions-table" class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Permission Name</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Office Section -->
            <div id="section-office" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">System Master</p>
                        <h1 class="page-title">Offices</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddOfficeModal()">
                        <i class="bi bi-geo-alt me-2"></i> Add Office
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="office-table" class="table">
                            <thead>
                                <tr>
                                    <th>Office Name</th>
                                    <th>Location</th>
                                    <th>Radius</th>
                                    <th>Address</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Shifts Section -->
            <div id="section-shifts" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">System Master</p>
                        <h1 class="page-title">Work Shifts</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddShiftModal()">
                        <i class="bi bi-clock me-2"></i> Add Shift
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="shifts-table" class="table">
                            <thead>
                                <tr>
                                    <th>Shift Name</th>
                                    <th>Check In</th>
                                    <th>Check Out</th>
                                    <th>Tolerance</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Holidays Section -->
            <div id="section-holidays" class="hidden">
                <div class="page-header d-flex justify-content-between align-items-end">
                    <div>
                        <p class="text-muted mb-1">System Master</p>
                        <h1 class="page-title">Public Holidays</h1>
                    </div>
                    <button class="btn btn-primary" onclick="showAddHolidayModal()">
                        <i class="bi bi-calendar-event me-2"></i> Add Holiday
                    </button>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table id="holidays-table" class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Holiday Name</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

    </div>
    </div>

    <!-- Generic Modal for Forms -->
    <div class="modal fade" id="formModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="font-weight: 700">Add Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Dynamic Form Content -->
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Leave Approval/Rejection -->
    <div class="modal fade" id="confirmLeaveModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title w-100 text-center" style="font-weight: 700" id="confirmLeaveTitle">Konfirmasi
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div id="confirmLeaveIcon" style="font-size: 3rem; margin-bottom: 12px;"></div>
                    <p id="confirmLeaveMessage" class="mb-0" style="font-size: 1rem; color: #475569;"></p>
                </div>
                <div class="modal-footer border-0 justify-content-center pt-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn" id="confirmLeaveBtn" onclick="executeLeaveAction()">Ya</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Lightbox Overlay -->
    <div class="foto-lightbox" id="fotoLightbox" onclick="closeLightbox()">
        <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
        <img id="lightboxImg" src="" alt="Foto" onclick="event.stopPropagation()">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet Maps JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- HTML5-QRCODE for QR Scanning -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        const API_URL = '/api';
        let formModal;
        let cachedData = {
            users: [],
            divisions: [],
            roles: [],
            permissions: [],
            offices: [],
            shifts: [],
            holidays: [],
            leaves: []
        };

        async function checkAuth() {
            try {
                const token = localStorage.getItem('token');
                if (token) {
                    // Fetch fresh user profile & permissions from API
                    try {
                        const meRes = await fetch(`${API_URL}/auth/me`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (meRes.status === 401 || meRes.status === 500) {
                            logout();
                            return;
                        }
                        if (meRes.ok) {
                            const meData = await meRes.json();
                            localStorage.setItem('userRole', meData.role || '');
                            localStorage.setItem('userPermissions', JSON.stringify(meData.permissions || []));
                        }
                    } catch (e) {
                        console.error('Failed to fetch user profile:', e);
                    }

                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('main-section').classList.remove('hidden');

                    // Apply RBAC to Sidebar
                    const userRole = localStorage.getItem('userRole');
                    if (userRole !== 'super_admin') {
                        document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
                    }

                    await loadMasterData();
                    switchTab('attendance');
                }
            } catch (err) {
                console.error("Auth check failed:", err);
            }
        }

        async function loadMasterData() {
            // Load roles, divisions, offices, and permissions for dropdowns/modals
            await Promise.all([
                loadRoles(),
                loadDivisions(),
                loadOffices(),
                loadPermissions()
            ]);
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('error-msg');

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();

                if (res.ok && data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('userRole', data.user.role || '');
                    localStorage.setItem('userPermissions', JSON.stringify(data.user.permissions || []));
                    location.reload();
                } else {
                    errorEl.innerText = data.message || 'Unauthorized access';
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                alert('Network error.');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            localStorage.removeItem('userPermissions');
            location.reload();
        }

        function hasApproveLeavePermission() {
            const userRole = localStorage.getItem('userRole');
            if (userRole === 'super_admin') return true;
            try {
                const perms = JSON.parse(localStorage.getItem('userPermissions') || '[]');
                const approvePerms = [
                    'manage_approve_leaves_staf',
                    'manage_approve_leaves_supervisor',
                    'manage_approve_leaves_manager',
                    'manage_approve_leaves_co_ceo',
                    'manage_approve_leaves_ceo',
                    'manage_approve_leaves_co_cto',
                    'manage_approve_leaves_cto',
                    'manage_approve_leaves_owners'
                ];
                return perms.some(p => approvePerms.includes(p));
            } catch (e) {
                return false;
            }
        }

        function switchTab(tab, el) {
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if (!el) {
                el = document.querySelector(`.nav-link[onclick*="'${tab}'"]`);
            }
            if (el) el.classList.add('active');

            const sections = ['attendance', 'attendance_transum', 'leaves', 'users', 'divisions', 'roles', 'permissions', 'office', 'shifts', 'holidays'];
            sections.forEach(s => {
                const sec = document.getElementById(`section-${s}`);
                if (sec) sec.classList.add('hidden');
            });
            const targetSec = document.getElementById(`section-${tab}`);
            if (targetSec) targetSec.classList.remove('hidden');

            const loaders = {
                attendance: loadAttendance,
                attendance_transum: loadAttendanceTransum,
                leaves: loadLeaves,
                users: loadUsers,
                divisions: loadDivisions,
                roles: loadRoles,
                permissions: loadPermissions,
                office: loadOffices,
                shifts: loadShifts,
                holidays: loadHolidays
            };
            if (loaders[tab]) loaders[tab]();
        }

        async function fetchAPI(endpoint) {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}${endpoint}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            // Don't auto-logout for 403 (Forbidden) if it's a staff accessing restricted area
            // Only logout on 401 (Unauthorized/Expired Token)
            if (res.status === 401) logout();
            return res.json();
        }

        function renderFotoCell(filename) {
            if (filename) {
                return `<img src="/uploads/upload_absensi/${filename}" alt="Foto" class="foto-thumbnail" onclick="openLightbox('/uploads/upload_absensi/${filename}')">`;
            }
            return `<div class="foto-placeholder"><i class="bi bi-image"></i></div>`;
        }

        function openLightbox(src) {
            const lightbox = document.getElementById('fotoLightbox');
            const img = document.getElementById('lightboxImg');
            img.src = src;
            lightbox.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox() {
            const lightbox = document.getElementById('fotoLightbox');
            lightbox.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close lightbox on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

        async function loadAttendance() {
            const data = await fetchAPI('/attendance/all');
            const tbody = document.querySelector('#attendance-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="fw-semibold">${row.name}</div>
                        <div class="text-muted small">${row.office_name || 'N/A'}</div>
                    </td>
                    <td>${row.check_in ? new Date(row.check_in).toLocaleString() : '-'}</td>
                    <td>${row.check_out ? new Date(row.check_out).toLocaleString() : '-'}</td>
                    <td><span class="badge ${row.status === 'present' ? 'bg-success-subtle' : 'bg-warning-subtle text-warning'}">${row.status.toUpperCase()}</span></td>
                    <td>${renderFotoCell(row.check_in_foto)}</td>
                    <td>${renderFotoCell(row.check_out_foto)}</td>
                    <td>${row.work_duration || 0} min</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ========== ATTENDANCE TRANSUM (Absensi Rabu) ==========
        async function loadAttendanceTransum() {
            const data = await fetchAPI('/attendance-transum');
            const tbody = document.querySelector('#transum-table tbody');
            tbody.innerHTML = '';
            if (!Array.isArray(data)) return;
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="fw-semibold">${row.name}</div>
                    </td>
                    <td><span class="badge bg-blue-subtle">${row.type_transum}</span></td>
                    <td>${row.city}</td>
                    <td>${row.check_in ? new Date(row.check_in).toLocaleString() : '-'}</td>
                    <td>${row.check_out ? new Date(row.check_out).toLocaleString() : '-'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light" onclick="showEditTransumModal(${row.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteTransum(${row.id})"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showAddTransumModal() {
            const usersOptions = (cachedData.users || []).map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            document.querySelector('#formModal .modal-title').textContent = 'Add Absensi Rabu';
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="submitTransum(event)">
                    <div class="mb-3">
                        <label class="form-label">User</label>
                        <select name="user_id" class="form-select" required>${usersOptions}</select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type Transum</label>
                        <select name="type_transum" class="form-select" required>
                            <option value="LRT">LRT</option>
                            <option value="LRT Jakarta">LRT Jakarta</option>
                            <option value="MRT">MRT</option>
                            <option value="Transjakarta">Transjakarta</option>
                            <option value="Jaklingko">Jaklingko</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">City</label>
                        <select name="city" class="form-select" required>
                            <option value="Jakarta Pusat">Jakarta Pusat</option>
                            <option value="Jakarta Timur">Jakarta Timur</option>
                            <option value="Jakarta Utara">Jakarta Utara</option>
                            <option value="Jakarta Barat">Jakarta Barat</option>
                            <option value="Jakarta Selatan">Jakarta Selatan</option>
                            <option value="Bekasi">Bekasi</option>
                            <option value="Tangerang Selatan">Tangerang Selatan</option>
                            <option value="Tangerang">Tangerang</option>
                            <option value="Depok">Depok</option>
                            <option value="Bogor">Bogor</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check In</label>
                            <input type="datetime-local" name="check_in" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check Out</label>
                            <input type="datetime-local" name="check_out" class="form-control">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check In Lat</label>
                            <input type="text" name="check_in_lat" class="form-control" placeholder="-6.200000">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check In Long</label>
                            <input type="text" name="check_in_long" class="form-control" placeholder="106.816666">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check Out Lat</label>
                            <input type="text" name="check_out_lat" class="form-control" placeholder="-6.200000">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check Out Long</label>
                            <input type="text" name="check_out_long" class="form-control" placeholder="106.816666">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            `;
            formModal.show();
        }

        async function submitTransum(e) {
            e.preventDefault();
            const form = e.target;
            const fd = new FormData(form);
            const body = Object.fromEntries(fd.entries());
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/attendance-transum`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                alert(data.message);
                formModal.hide();
                loadAttendanceTransum();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function showEditTransumModal(id) {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/attendance-transum/${id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const item = await res.json();
            const usersOptions = (cachedData.users || []).map(u => `<option value="${u.id}" ${u.id === item.user_id ? 'selected' : ''}>${u.name}</option>`).join('');

            const typeOptions = ['LRT', 'LRT Jakarta', 'MRT', 'Transjakarta', 'Jaklingko']
                .map(t => `<option value="${t}" ${t === item.type_transum ? 'selected' : ''}>${t}</option>`).join('');

            const cityOptions = ['Jakarta Pusat', 'Jakarta Timur', 'Jakarta Utara', 'Jakarta Barat', 'Jakarta Selatan', 'Bekasi', 'Tangerang Selatan', 'Tangerang', 'Depok', 'Bogor']
                .map(c => `<option value="${c}" ${c === item.city ? 'selected' : ''}>${c}</option>`).join('');

            const fmtDT = (d) => d ? new Date(d).toISOString().slice(0, 16) : '';

            document.querySelector('#formModal .modal-title').textContent = 'Edit Absensi Rabu';
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="updateTransum(event, ${id})">
                    <div class="mb-3">
                        <label class="form-label">User</label>
                        <select name="user_id" class="form-select" required>${usersOptions}</select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type Transum</label>
                        <select name="type_transum" class="form-select" required>${typeOptions}</select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">City</label>
                        <select name="city" class="form-select" required>${cityOptions}</select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check In</label>
                            <input type="datetime-local" name="check_in" class="form-control" value="${fmtDT(item.check_in)}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check Out</label>
                            <input type="datetime-local" name="check_out" class="form-control" value="${fmtDT(item.check_out)}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check In Lat</label>
                            <input type="text" name="check_in_lat" class="form-control" value="${item.check_in_lat || ''}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check In Long</label>
                            <input type="text" name="check_in_long" class="form-control" value="${item.check_in_long || ''}">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check Out Lat</label>
                            <input type="text" name="check_out_lat" class="form-control" value="${item.check_out_lat || ''}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Check Out Long</label>
                            <input type="text" name="check_out_long" class="form-control" value="${item.check_out_long || ''}">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </form>
            `;
            formModal.show();
        }

        async function updateTransum(e, id) {
            e.preventDefault();
            const form = e.target;
            const fd = new FormData(form);
            const body = Object.fromEntries(fd.entries());
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/attendance-transum/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                alert(data.message);
                formModal.hide();
                loadAttendanceTransum();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteTransum(id) {
            if (!confirm('Delete this record?')) return;
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/attendance-transum/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                alert(data.message);
                loadAttendanceTransum();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function loadUsers() {
            const data = await fetchAPI('/users');
            cachedData.users = data;
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.email}</td>
                    <td>${row.name}</td>
                    <td>${row.division || 'N/A'}</td>
                    <td>${row.role || 'N/A'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light" onclick="showEditUserModal(${row.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteItem('users', ${row.id}, loadUsers)"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadDivisions() {
            const data = await fetchAPI('/divisions');
            cachedData.divisions = data;
            const tbody = document.querySelector('#divisions-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.divisions_name}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light" onclick="showEditDivisionModal(${row.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteItem('divisions', ${row.id}, loadDivisions)"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadRoles() {
            const data = await fetchAPI('/roles');
            cachedData.roles = data;
            const tbody = document.querySelector('#roles-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.roles_name}</td>
                    <td><small class="text-muted">${row.permissions || '-'}</small></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light" onclick="showEditRoleModal(${row.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteItem('roles', ${row.id}, loadRoles)"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadPermissions() {
            const data = await fetchAPI('/permissions');
            cachedData.permissions = data;
            const tbody = document.querySelector('#permissions-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.id}</td>
                    <td>${row.permissions_name}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light" onclick="showEditPermissionModal(${row.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteItem('permissions', ${row.id}, loadPermissions)"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadOffices() {
            const data = await fetchAPI('/offices');
            cachedData.offices = data;
            const tbody = document.querySelector('#office-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.office_name}</td>
                    <td>${row.latitude}, ${row.longitude}</td>
                    <td>${row.radius_meter}m</td>
                    <td>${row.address || '-'}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light" onclick="showEditOfficeModal(${row.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteItem('offices', ${row.id}, loadOffices)"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadShifts() {
            const data = await fetchAPI('/shifts');
            cachedData.shifts = data;
            const tbody = document.querySelector('#shifts-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.shift_name}</td>
                    <td>${row.check_in}</td>
                    <td>${row.check_out}</td>
                    <td>${row.late_tolerance_minute} min</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light" onclick="showEditShiftModal(${row.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteItem('shifts', ${row.id}, loadShifts)"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadHolidays() {
            const data = await fetchAPI('/holidays');
            cachedData.holidays = data;
            const tbody = document.querySelector('#holidays-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(row.holiday_date).toLocaleDateString()}</td>
                    <td>${row.holiday_name}</td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-light" onclick="showEditHolidayModal(${row.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteItem('holidays', ${row.id}, loadHolidays)"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadLeaves() {
            const data = await fetchAPI('/leaves');
            cachedData.leaves = data;
            const tbody = document.querySelector('#leaves-table tbody');
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.user_name}</td>
                    <td><span class="badge bg-light text-dark">${row.leave_type.toUpperCase()}</span></td>
                    <td>${new Date(row.start_date).toLocaleDateString()} - ${new Date(row.end_date).toLocaleDateString()}</td>
                    <td>${row.reason || '-'}</td>
                    <td><span class="badge ${row.status === 'approved' ? 'bg-success' : (row.status === 'rejected' ? 'bg-danger' : 'bg-warning')}">${row.status.toUpperCase()}</span></td>
                    <td class="text-end">
                        ${(row.status === 'pending' && hasApproveLeavePermission()) ? `
                            <button class="btn btn-sm btn-success me-1" onclick="confirmLeaveAction(${row.id}, 'approved')"><i class="bi bi-check-lg"></i></button>
                            <button class="btn btn-sm btn-danger me-1" onclick="confirmLeaveAction(${row.id}, 'rejected')"><i class="bi bi-x-lg"></i></button>
                        ` : ''}
                        <button class="btn btn-sm btn-light text-danger" onclick="deleteItem('leaves', ${row.id}, loadLeaves)"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        let pendingLeaveAction = { id: null, status: null };

        function confirmLeaveAction(id, status) {
            pendingLeaveAction = { id, status };
            const isApprove = status === 'approved';
            document.getElementById('confirmLeaveTitle').textContent = isApprove ? 'Approve Cuti' : 'Tolak Cuti';
            document.getElementById('confirmLeaveIcon').innerHTML = isApprove
                ? '<i class="bi bi-check-circle-fill" style="color: #22c55e;"></i>'
                : '<i class="bi bi-x-circle-fill" style="color: #ef4444;"></i>';
            document.getElementById('confirmLeaveMessage').textContent = isApprove
                ? 'Apakah Anda yakin ingin menyetujui cuti ini?'
                : 'Apakah Anda yakin ingin menolak cuti ini?';
            const confirmBtn = document.getElementById('confirmLeaveBtn');
            confirmBtn.className = isApprove ? 'btn btn-success' : 'btn btn-danger';
            confirmBtn.textContent = isApprove ? 'Ya, Setujui' : 'Ya, Tolak';
            new bootstrap.Modal(document.getElementById('confirmLeaveModal')).show();
        }

        async function executeLeaveAction() {
            const { id, status } = pendingLeaveAction;
            if (!id) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/leaves/${id}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ status })
            });
            bootstrap.Modal.getInstance(document.getElementById('confirmLeaveModal')).hide();
            if (res.ok) loadLeaves();
            pendingLeaveAction = { id: null, status: null };
        }

        async function deleteItem(type, id, callback) {
            if (!confirm('Are you sure?')) return;
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/${type}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) callback();
        }

        async function handleFormSubmit(event, endpoint, callback, method = 'POST') {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = {};

            formData.forEach((value, key) => {
                if (data[key]) {
                    if (!Array.isArray(data[key])) {
                        data[key] = [data[key]];
                    }
                    data[key].push(value);
                } else {
                    data[key] = value;
                }
            });

            const token = localStorage.getItem('token');

            const res = await fetch(`${API_URL}${endpoint}`, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                formModal.hide();
                callback();
            } else {
                const err = await res.json();
                alert(err.message || 'Error');
            }
        }

        function showAddDivisionModal() {
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/divisions', loadDivisions)">
                    <div class="mb-3">
                        <label class="form-label">Division Name</label>
                        <input type="text" name="division_name" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            `;
            formModal.show();
        }

        function showAddShiftModal() {
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/shifts', loadShifts)">
                    <div class="mb-3">
                        <label class="form-label">Shift Name</label>
                        <input type="text" name="shift_name" class="form-control" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col"><label class="form-label">Check In</label><input type="time" name="check_in" class="form-control" required></div>
                        <div class="col"><label class="form-label">Check Out</label><input type="time" name="check_out" class="form-control" required></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tolerance (min)</label>
                        <input type="number" name="late_tolerance_minute" class="form-control" value="10">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            `;
            formModal.show();
        }

        function showAddDivisionModal() {
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/divisions', loadDivisions)">
                    <div class="mb-3">
                        <label class="form-label">Division Name</label>
                        <input type="text" name="divisions_name" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            `;
            formModal.show();
        }

        function showAddRoleModal() {
            const divs = cachedData.divisions.map(d => `<option value="${d.id}">${d.divisions_name}</option>`).join('');
            const perms = cachedData.permissions.map(p => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="permissions" value="${p.id}" id="permAdd${p.id}">
                    <label class="form-check-label" for="permAdd${p.id}">${p.permissions_name}</label>
                </div>
            `).join('');

            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/roles', loadRoles)">
                    <div class="mb-3">
                        <label class="form-label">Role Name</label>
                        <input type="text" name="roles_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Division Scope</label>
                        <select name="division_id" class="form-select">${divs}</select>
                        <small class="text-muted">Permissions will be assigned to this division.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            ${perms}
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            `;
            formModal.show();
        }

        function showAddPermissionModal() {
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/permissions', loadPermissions)">
                    <div class="mb-3">
                        <label class="form-label">Permission Name</label>
                        <input type="text" name="permissions_name" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            `;
            formModal.show();
        }

        function showAddHolidayModal() {
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/holidays', loadHolidays)">
                    <div class="mb-3">
                        <label class="form-label">Holiday Date</label>
                        <input type="date" name="holiday_date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Holiday Name</label>
                        <input type="text" name="holiday_name" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            `;
            formModal.show();
        }

        function showAddUserModal() {
            const divisions = cachedData.divisions.map(d => `<option value="${d.id}">${d.divisions_name}</option>`).join('');
            const offices = cachedData.offices.map(o => `<option value="${o.id}">${o.office_name}</option>`).join('');
            const roles = cachedData.roles.map(r => `<option value="${r.id}">${r.roles_name}</option>`).join('');

            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/users', loadUsers)">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" name="password" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Office</label>
                        <select name="office_id" class="form-select">${offices}</select>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Division</label>
                            <select name="division_id" class="form-select">${divisions}</select>
                        </div>
                        <div class="col">
                            <label class="form-label">Role</label>
                            <select name="role_id" class="form-select">${roles}</select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            `;
            formModal.show();
        }

        function showAddOfficeModal() {
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/offices', loadOffices)">
                    <div class="mb-3">
                        <label class="form-label">Office Name</label>
                        <input type="text" name="office_name" class="form-control" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col"><label class="form-label">Lat</label><input type="text" name="latitude" class="form-control" required></div>
                        <div class="col"><label class="form-label">Long</label><input type="text" name="longitude" class="form-control" required></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Radius (meters)</label>
                        <input type="number" name="radius_meter" class="form-control" value="100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Save</button>
                </form>
            `;
            formModal.show();
        }

        function showAddLeaveModal() {
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/leaves', loadLeaves)">
                    <div class="mb-3">
                        <label class="form-label">User ID (Manual for now)</label>
                        <input type="number" name="user_id" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Leave Type</label>
                        <select name="leave_type" class="form-select">
                            <option value="annual">Annual</option>
                            <option value="sick">Sick</option>
                            <option value="permission">Permission</option>
                        </select>
                    </div>
                    <div class="row mb-3">
                        <div class="col"><label class="form-label">Start Date</label><input type="date" name="start_date" class="form-control" required></div>
                        <div class="col"><label class="form-label">End Date</label><input type="date" name="end_date" class="form-control" required></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason</label>
                        <textarea name="reason" class="form-control"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Submit Request</button>
                </form>
            `;
            formModal.show();
        }

        async function exportData() {
            const token = localStorage.getItem('token');
            const res = await fetch(`${API_URL}/attendance/export`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) {
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance_${new Date().getTime()}.xlsx`;
                a.click();
            }
        }

        function showEditDivisionModal(id) {
            const item = cachedData.divisions.find(d => d.id === id);
            if (!item) return;
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/divisions/${id}', loadDivisions, 'PUT')">
                    <div class="mb-3">
                        <label class="form-label">Division Name</label>
                        <input type="text" name="divisions_name" class="form-control" value="${item.divisions_name}" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </form>
            `;
            formModal.show();
        }

        async function showEditRoleModal(id) {
            const item = cachedData.roles.find(r => r.id === id);
            if (!item) return;

            // Load current permissions for this role (first division found or select division)
            // For simplicity, we'll allow selecting division and it will refresh the checkboxes
            const divs = cachedData.divisions.map(d => `<option value="${d.id}">${d.divisions_name}</option>`).join('');

            const renderPerms = (activePermIds = []) => {
                return cachedData.permissions.map(p => `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="permissions" value="${p.id}" id="permEdit${p.id}" ${activePermIds.includes(p.id) ? 'checked' : ''}>
                        <label class="form-check-label" for="permEdit${p.id}">${p.permissions_name}</label>
                    </div>
                `).join('');
            };

            document.getElementById('modal-body').innerHTML = `
                <form id="edit-role-form" onsubmit="handleFormSubmit(event, '/roles/${id}', loadRoles, 'PUT')">
                    <div class="mb-3">
                        <label class="form-label">Role Name</label>
                        <input type="text" name="roles_name" class="form-control" value="${item.roles_name}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Division Scope</label>
                        <select name="division_id" id="edit-role-div" class="form-select" onchange="refreshRolePermissions(${id})">${divs}</select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Permissions</label>
                        <div id="edit-role-perms" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                            ${renderPerms()}
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </form>
            `;
            formModal.show();
            refreshRolePermissions(id);
        }

        async function refreshRolePermissions(roleId) {
            const divId = document.getElementById('edit-role-div').value;
            const res = await fetchAPI(`/roles/${roleId}/permissions`);
            // Filtering by division from the response (since API returns all)
            const activePermIds = res.filter(p => p.divisions_id == divId).map(p => p.id_permissions);

            const permsContainer = document.getElementById('edit-role-perms');
            permsContainer.innerHTML = cachedData.permissions.map(p => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="permissions" value="${p.id}" id="permEdit${p.id}" ${activePermIds.includes(p.id) ? 'checked' : ''}>
                    <label class="form-check-label" for="permEdit${p.id}">${p.permissions_name}</label>
                </div>
            `).join('');
        }

        function showEditPermissionModal(id) {
            const item = cachedData.permissions.find(p => p.id === id);
            if (!item) return;
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/permissions/${id}', loadPermissions, 'PUT')">
                    <div class="mb-3">
                        <label class="form-label">Permission Name</label>
                        <input type="text" name="permissions_name" class="form-control" value="${item.permissions_name}" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </form>
            `;
            formModal.show();
        }

        function showEditShiftModal(id) {
            const item = cachedData.shifts.find(s => s.id === id);
            if (!item) return;
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/shifts/${id}', loadShifts, 'PUT')">
                    <div class="mb-3">
                        <label class="form-label">Shift Name</label>
                        <input type="text" name="shift_name" class="form-control" value="${item.shift_name}" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col"><label class="form-label">Check In</label><input type="time" name="check_in" class="form-control" value="${item.check_in}" required></div>
                        <div class="col"><label class="form-label">Check Out</label><input type="time" name="check_out" class="form-control" value="${item.check_out}" required></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tolerance (min)</label>
                        <input type="number" name="late_tolerance_minute" class="form-control" value="${item.late_tolerance_minute}">
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </form>
            `;
            formModal.show();
        }

        function showEditHolidayModal(id) {
            const item = cachedData.holidays.find(h => h.id === id);
            if (!item) return;
            const date = new Date(item.holiday_date).toISOString().split('T')[0];
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/holidays/${id}', loadHolidays, 'PUT')">
                    <div class="mb-3">
                        <label class="form-label">Holiday Date</label>
                        <input type="date" name="holiday_date" class="form-control" value="${date}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Holiday Name</label>
                        <input type="text" name="holiday_name" class="form-control" value="${item.holiday_name}" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </form>
            `;
            formModal.show();
        }

        function showEditUserModal(id) {
            const item = cachedData.users.find(u => u.id === id);
            if (!item) return;

            const divisions = cachedData.divisions.map(d => `<option value="${d.id}" ${d.id === item.division_id ? 'selected' : ''}>${d.divisions_name}</option>`).join('');
            const offices = cachedData.offices.map(o => `<option value="${o.id}" ${o.id === item.office_id ? 'selected' : ''}>${o.office_name}</option>`).join('');
            const roles = cachedData.roles.map(r => `<option value="${r.id}" ${r.id === item.role_id ? 'selected' : ''}>${r.roles_name}</option>`).join('');

            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/users/${id}', loadUsers, 'PUT')">
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" name="email" class="form-control" value="${item.email}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password (Leave blank to keep current)</label>
                        <input type="password" name="password" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" value="${item.name}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Office</label>
                        <select name="office_id" class="form-select">${offices}</select>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label">Division</label>
                            <select name="division_id" class="form-select">${divisions}</select>
                        </div>
                        <div class="col">
                            <label class="form-label">Role</label>
                            <select name="role_id" class="form-select">${roles}</select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select name="is_active" class="form-select">
                            <option value="1" ${item.is_active ? 'selected' : ''}>Active</option>
                            <option value="0" ${!item.is_active ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </form>
            `;
            formModal.show();
        }

        function showEditOfficeModal(id) {
            const item = cachedData.offices.find(o => o.id === id);
            if (!item) return;
            document.getElementById('modal-body').innerHTML = `
                <form onsubmit="handleFormSubmit(event, '/offices/${id}', loadOffices, 'PUT')">
                    <div class="mb-3">
                        <label class="form-label">Office Name</label>
                        <input type="text" name="office_name" class="form-control" value="${item.office_name}" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col"><label class="form-label">Lat</label><input type="text" name="latitude" class="form-control" value="${item.latitude}" required></div>
                        <div class="col"><label class="form-label">Long</label><input type="text" name="longitude" class="form-control" value="${item.longitude}" required></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Radius (meters)</label>
                        <input type="number" name="radius_meter" class="form-control" value="${item.radius_meter}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control">${item.address || ''}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Update</button>
                </form>
            `;
            formModal.show();
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const icon = document.getElementById('hamburgerIcon');
            menu.classList.toggle('open');
            if (menu.classList.contains('open')) {
                icon.classList.remove('bi-list');
                icon.classList.add('bi-x-lg');
            } else {
                icon.classList.remove('bi-x-lg');
                icon.classList.add('bi-list');
            }
        }

        // Updated switchTab to sync active states across sidebar & mobile menu and close mobile menu
        const originalSwitchTab = switchTab;
        switchTab = function (tab, el) {
            originalSwitchTab(tab, el);
            // Sync active class on both sidebar (desktop) and mobile nav-links
            document.querySelectorAll('#sidebar .nav-link, #mobileMenu .nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll(`#sidebar .nav-link[onclick*="'${tab}'"], #mobileMenu .nav-link[onclick*="'${tab}'"]`).forEach(l => l.classList.add('active'));
            // Close mobile menu after selection
            const menu = document.getElementById('mobileMenu');
            if (menu.classList.contains('open')) {
                toggleMobileMenu();
            }
        };

        window.onload = () => {
            formModal = new bootstrap.Modal(document.getElementById('formModal'));
            checkAuth();
        };
    </script>
</body>

</html>